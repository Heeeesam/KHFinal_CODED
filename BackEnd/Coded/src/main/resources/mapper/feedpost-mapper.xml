<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FeedPost">

	<insert id="insertFeedPost">
		insert into FeedPost values(FeedPost_seq.nextval, ${userNo},
		#{body}, sysdate,
		${writeTemp}, ${writeTempRange})
	</insert>
	
	<insert id="insertFeedPhoto">
		insert into FeedPhoto values(FeedPost_seq.nextval,
		#{oriName}, #{sysname}, ${feedPostId},
		0,0)
	</insert>

	<insert id="insertHashTag">
		insert into HashTag values(Hashtag_seq.nextval,
		#{hashTag})
	</insert>

	<insert id="insertPostHashs">
		insert into PostHashs values(PostHashs_seq.nextval,
		#{feedPostId}, #{tagId})
	</insert>
	<select id="selectByUserNoList" resultType="kh.coded.dto.FeedPostDTO">
		select * from FeedPost where userno = ${userno}
	</select>
	
	<select id="selectTestFeedList" resultType="kh.coded.dto.FeedPostDTO">
		select * from feedpost order by feedpostid desc
	</select>
	
	<select id="searchByFeedPost" resultType="kh.coded.dto.FeedPostDTO">
		select * from feedpost where feedpostid = ${FeedPostId} <!-- 위에서 뽑아낸 포스트 아이디를 가지고 피드를 뽑아냄 -->
	</select>

	<select id="selectAllFeedPost" resultType="kh.coded.dto.FeedPostDTO">
		select * from (select feedPost.*, row_number() over(order by FeedPostId desc) rn from feedPost) where rn between ${startFeedNum} and ${endFeedNum}
	</select>
	
	<select id="selectPagingWeatherDiff" resultType="kh.coded.dto.FeedPostDTO">
		select f.*,
		 (select ABS(f.writeTemp - ${targetTemp}) from dual) as writeTempDiff,
		 (select ABS(f.writeTempRange - ${targetTempRange}) from dual) as writeTempRangeDiff
		from (select feedpost.*, row_number() over(order by FeedPostId desc) rn from feedpost) f
		where rn between ${startFeedNum} and ${endFeedNum}
		order by writeTempDiff asc, writeTempRangeDiff asc
	</select>

	<select id="selectSearchFeedListByHashs" resultType="kh.coded.dto.FeedPostDTO">
		select * from
		(select feedpost.*, row_number() over (order by feedpostid desc) as rn from
		(select * from (select distinct feedpostid from hashtag join posthashs using (tagid) where hashtag like '%'|| #{keyword} || '%')
		join feedpost using (feedpostid)) feedpost)
		where rn between ${startFeedNum} and ${endFeedNum}
	</select>

	<update id="updateFeedPost">
		update feedpost set body = #{body} where feedpostid = ${feedpostid}
	</update>

	<delete id="deleteFeedPost">
		delete feedpost where feedpostid = ${feedpostid}
	</delete>

</mapper>